name: Deploy to Cloudflare Workers

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  # Deploy to dev environment on push to main
  deploy-dev:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    name: Deploy to Dev
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: "0.120.4"
          extended: true

      - name: Build Hugo site
        run: cd biosugar0 && hugo --gc --minify
        env:
          HUGO_ENV: production

      - name: Deploy to Cloudflare Workers (Dev)
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          wranglerVersion: "4"
          command: deploy --env dev

      - name: Comment deployment URL
        uses: actions/github-script@v8
        if: success()
        with:
          script: |
            const commitSha = context.sha.substring(0, 7);
            const message = [
              'âœ… Devç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸï¼',
              '',
              '**URL:** https://biosugar0-com-dev.${context.repo.owner}.workers.dev',
              '',
              `Commit: ${commitSha}`
            ].join('\n');

            const { data: comments } = await github.rest.repos.listCommentsForCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Devç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤')
            );

            if (botComment) {
              await github.rest.repos.updateCommitComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: message
              });
            } else {
              await github.rest.repos.createCommitComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                commit_sha: context.sha,
                body: message
              });
            }

  # Deploy to production environment on tag push
  deploy-production:
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    name: Deploy to Production
    environment:
      name: production
      url: https://www.biosugar0.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: "0.120.4"
          extended: true

      - name: Build Hugo site
        run: cd biosugar0 && hugo --gc --minify
        env:
          HUGO_ENV: production

      - name: Deploy to Cloudflare Workers (Production)
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          wranglerVersion: "4"
          command: deploy --env production

      - name: Create GitHub Release
        uses: actions/github-script@v8
        if: success()
        with:
          script: |
            const tagName = context.ref.replace('refs/tags/', '');
            const releaseMessage = [
              'ðŸš€ Production deployment successful!',
              '',
              '**URL:** https://www.biosugar0.com',
              '',
              `Tag: ${tagName}`
            ].join('\n');

            try {
              await github.rest.repos.createRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_name: tagName,
                name: tagName,
                body: releaseMessage,
                draft: false,
                prerelease: false
              });
            } catch (error) {
              console.log('Release might already exist:', error.message);
            }

  # Deploy preview environment for pull requests
  deploy-preview:
    if: github.event_name == 'pull_request' && github.event.action != 'closed'
    runs-on: ubuntu-latest
    name: Deploy Preview
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: "0.120.4"
          extended: true

      - name: Build Hugo site
        run: cd biosugar0 && hugo --gc --minify
        env:
          HUGO_ENV: production

      - name: Deploy Preview to Cloudflare Workers
        id: deploy
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          wranglerVersion: "4"
          command: versions upload --env dev --preview-alias pr-${{ github.event.pull_request.number }}
